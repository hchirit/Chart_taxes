# Claude.MD - Guide du Projet TX Dashboard

## Vue d'ensemble du projet

**Nom**: Dashboard  - ×¨×©×•×ª ×”××™×¡×™× (AutoritÃ© fiscale israÃ©lienne)

**Objectif principal**: Application web de visualisation de donnÃ©es  pour afficher et analyser les statistiques de projets et tÃ¢ches de l'autoritÃ© fiscale israÃ©lienne.

## Architecture et Principes de Base

### 1. Architecture Modulaire
Le projet suit une architecture modulaire stricte :

```
TX/
â”œâ”€â”€ index.html                    # Point d'entrÃ©e principal
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.js                   # Orchestration principale
â”‚   â”œâ”€â”€ charts/                   # Tous les graphiques
â”‚   â”‚   â””â”€â”€ hierarchicalChart.js  # Chart hiÃ©rarchique actuel
â”‚   â”œâ”€â”€ data/
â”‚   â”‚   â””â”€â”€ dataTransformer.js    # Transformation des donnÃ©es
â”‚   â”œâ”€â”€ filters/
â”‚   â”‚   â””â”€â”€ filterManager.js      # Gestion centralisÃ©e des filtres
â”‚   â””â”€â”€ utils/
â”‚       â””â”€â”€ chartConfig.js        # Configuration commune
â”œâ”€â”€ styles/
â”‚   â””â”€â”€ chart.css                 # Styles CSS
â”œâ”€â”€ getDataFromQuery.js           # RÃ©cupÃ©ration depuis serveur
â”œâ”€â”€ filtersConfig.js              # Configuration des filtres
â””â”€â”€ filter.js                     # Logique des filtres
```

### 2. SystÃ¨me de Filtres UnifiÃ©

**CRITÃˆRE CRUCIAL**: Les filtres doivent affecter TOUS les graphiques de la page.

#### Filtres disponibles :
- **AnnÃ©e** (yearFilter) - Filtre principal
- **OBS** (obsFilter) - Organisation
- **Mises Ã  jour de tÃ¢ches** (taskUpdatesFilter)
- **Responsable** (responsibleFilter)

#### MÃ©canisme :
1. Le `FilterManager` (src/filters/filterManager.js) centralise la gestion des filtres
2. Lorsqu'un filtre change, un Ã©vÃ©nement `filtersChanged` est dispatchÃ©
3. Tous les graphiques Ã©coutent cet Ã©vÃ©nement et se rafraÃ®chissent
4. L'Ã©vÃ©nement `filterSelected` est utilisÃ© pour les changements individuels

```javascript
// Exemple d'Ã©coute des filtres dans un nouveau chart
document.addEventListener('filtersChanged', function(event) {
    const filters = event.detail.filters;
    // RafraÃ®chir le graphique avec les nouveaux filtres
});
```

### 3. SystÃ¨me Multi-Graphiques

**VISION FUTURE**: La page doit supporter plusieurs graphiques simultanÃ©ment.

#### Principes pour ajouter un nouveau graphique :

1. **CrÃ©er le fichier du graphique** dans `src/charts/`
   ```javascript
   // Exemple: src/charts/barChart.js
   class BarChart {
       constructor(canvasId) {
           this.canvas = document.getElementById(canvasId);
           this.chart = null;
       }

       render(data) {
           // Logique de rendu
       }

       destroy() {
           if (this.chart) this.chart.destroy();
       }
   }
   window.BarChart = BarChart;
   ```

2. **Ajouter le canvas dans index.html**
   ```html
   <div class="chart-container">
       <canvas id="barChart"></canvas>
   </div>
   ```

3. **Initialiser dans main.js**
   ```javascript
   let barChart = new BarChart('barChart');
   barChart.render(transformedData);
   ```

4. **Ã‰couter les Ã©vÃ©nements de filtres**
   ```javascript
   document.addEventListener('filtersChanged', function(event) {
       barChart.render(getFilteredData(event.detail.filters));
   });
   ```

### 4. SystÃ¨me de Badges

Les badges en haut de la page affichent des statistiques calculÃ©es dynamiquement :

- **Badge Primaire** : Bi×¦×•×¢ ×›×œ×œ×™ (ExÃ©cution gÃ©nÃ©rale)
- **Badge Secondaire** : Bi×¦×•×¢ ×¤×¨×•×™×§×˜×™× ×©×”×•××¨×• (ExÃ©cution projets convertis)
- **Badge Tertiaire** : Bi×¦×•Ø¹ ×©× ×ª×™ (ExÃ©cution annuelle)
- **Badge Quaternaire** : Bi×¦×•×¢ ×©×œ×™×©×•× ×™ (ExÃ©cution trimestrielle)

Ces badges sont mis Ã  jour par `updateHeaderBadges()` dans main.js.

## Technologies UtilisÃ©es

### BibliothÃ¨ques :
- **Chart.js 3.9.1** - Rendu des graphiques
- **chartjs-plugin-datalabels** - Labels sur les graphiques
- **getDataFromQuery.js** - RequÃªtes XOG vers le serveur

### Langages :
- JavaScript (ES6+) avec classes
- HTML5 + CSS3
- HÃ©breu (direction RTL)

## Flux de DonnÃ©es

1. **RÃ©cupÃ©ration** : `getDataFromQuery.js` â†’ Serveur XOG
2. **Stockage** : Variable globale `allIdea` (data.js)
3. **Transformation** : `DataTransformer.transformToHierarchy()`
4. **Filtrage** : `FilterManager` applique les filtres
5. **Rendu** : Chaque graphique reÃ§oit les donnÃ©es filtrÃ©es
6. **Mise Ã  jour** : Ã‰vÃ©nements personnalisÃ©s pour synchroniser

## Conventions de Code

### 1. Nomenclature
- **Classes** : PascalCase (ex: `HierarchicalChart`, `FilterManager`)
- **Fonctions** : camelCase (ex: `renderChart`, `loadData`)
- **Constantes** : camelCase pour les variables (ex: `selectedYear`)
- **IDs HTML** : camelCase (ex: `yearFilter`, `hierarchyChart`)

### 2. Structure des Classes
Chaque graphique doit avoir :
- Constructeur avec `canvasId`
- MÃ©thode `render(data)`
- MÃ©thode `destroy()` pour nettoyer
- PropriÃ©tÃ© `this.chart` pour l'instance Chart.js

### 3. Ã‰vÃ©nements PersonnalisÃ©s
- `filterSelected` : Changement d'un filtre individuel
- `filtersChanged` : Changement de tous les filtres
- Toujours inclure les donnÃ©es dans `event.detail`

### 4. Gestion des Erreurs
- Try-catch dans toutes les fonctions principales
- Logs console pour le debugging
- Affichage des erreurs Ã  l'utilisateur via `showError()`

## Principes de DÃ©veloppement

### 1. ModularitÃ©
- Un fichier = Une responsabilitÃ©
- Classes rÃ©utilisables
- Couplage faible entre modules

### 2. ExtensibilitÃ©
- Facile d'ajouter de nouveaux graphiques
- Facile d'ajouter de nouveaux filtres
- Configuration centralisÃ©e

### 3. Performance
- Debounce sur le resize (250ms)
- Animation smooth (800ms)
- Destruction des graphiques avant recrÃ©ation

### 4. Support Multilingue
- Interface en hÃ©breu (RTL)
- Support des caractÃ¨res hÃ©braÃ¯ques
- Direction `dir="rtl"` sur `<html>`

## Roadmap et Ã‰volutions Futures

### Phase 1 : Multi-Charts (Prioritaire)
- [ ] Ajouter un graphique en barres pour les statistiques par OBS
- [ ] Layout grid responsive pour organiser les graphiques
- [ ] Les filtres doivent rafraÃ®chir TOUS les graphiques simultanÃ©ment

### Phase 2 : Filtres AvancÃ©s
- [ ] Peupler dynamiquement les filtres depuis les donnÃ©es
- [ ] Ajouter des filtres de date (dÃ©but/fin)
- [ ] Ajouter un bouton "RÃ©initialiser les filtres"
- [ ] Sauvegarder les filtres dans localStorage

### Phase 3 : InteractivitÃ©
- [ ] Clic sur un nÅ“ud pour afficher les dÃ©tails
- [ ] Drill-down dans les donnÃ©es
- [ ] Export des graphiques en image
- [ ] Export des donnÃ©es en Excel

### Phase 4 : Performance et UX
- [ ] Lazy loading des graphiques
- [ ] Skeleton loaders pendant le chargement
- [ ] Animations entre les transitions de filtres
- [ ] Mode sombre / clair

## Points d'Attention Critiques

### ğŸ”´ TOUJOURS RESPECTER :

1. **Filtres universels** : Tout filtre doit affecter tous les graphiques
2. **Architecture modulaire** : Ne pas mÃ©langer les responsabilitÃ©s
3. **Support RTL** : Interface en hÃ©breu uniquement
4. **CompatibilitÃ©** : Tester avec les donnÃ©es rÃ©elles du serveur
5. **Performance** : Optimiser pour de grandes quantitÃ©s de donnÃ©es

### ğŸŸ¡ CONVENTIONS Ã€ SUIVRE :

1. Commenter en franÃ§ais (ou anglais) dans le code
2. Labels UI en hÃ©breu
3. Console logs pour le debugging
4. Toujours tester avec plusieurs filtres actifs
5. VÃ©rifier la responsivitÃ© sur diffÃ©rents Ã©crans

### ğŸŸ¢ BONNES PRATIQUES :

1. Utiliser Chart.js pour tous les graphiques
2. Centraliser la configuration dans `chartConfig.js`
3. RÃ©utiliser `DataTransformer` pour toutes les transformations
4. Garder `main.js` comme orchestrateur principal
5. Exposer les API publiques via `window.nomFonction`

## API Publiques Disponibles

```javascript
// Mettre Ã  jour l'annÃ©e affichÃ©e
window.updateChart(2026);

// RafraÃ®chir tous les graphiques
window.refreshChart();

// Mettre Ã  jour les badges manuellement
window.updateBadges({
    primary: 85,
    secondary: 92,
    tertiary: 78,
    quaternary: 88
});

// AccÃ©der au gestionnaire de filtres
filterManager.getActiveFilters();
filterManager.resetFilters();
filterManager.populateFilter('obsFilter', [
    { value: 'obs1', label: 'OBS 1' },
    { value: 'obs2', label: 'OBS 2' }
]);
```

## IntÃ©gration avec Clarity PPM

Le projet s'intÃ¨gre avec Clarity PPM (serveur XOG) :

```javascript
// RÃ©cupÃ©ration des donnÃ©es
const url = window.document.URL;
const serverName = url.substring(0, url.indexOf("niku/") - 1);
const filters = { year: selectedYear };
rawData = ExecuteClarityQuery("dash_rashut_pm", serverName, filters);
```

**RequÃªtes disponibles** :
- `dash_rashut_pm` : DonnÃ©es principales du dashboard
- `obs_gitty` : Liste des OBS disponibles

## Format des DonnÃ©es

### EntrÃ©e (depuis le serveur) :
```javascript
[
    {
        common_shaam: 'true',
        apro_start_year: 2025,
        statut_idea_changeme: '4',
        status: '8',
        start: '2025-01-01',
        // ... autres champs
    }
]
```

### Sortie (aprÃ¨s transformation) :
```javascript
{
    nodes: [
        {
            id: 'root',
            label: '1,496',
            title: '×¡×”"×› ××©×™××•×ª',
            level: 0,
            x: 50,
            y: 10,
            color: '#d6e9f5',
            borderColor: '#4479ba'
        }
    ],
    connections: [
        { from: 'root', to: 'child', label: '95%' }
    ]
}
```

## Notes pour Claude

Lorsque tu travailles sur ce projet :

1. **Toujours consulter ce fichier** avant de proposer des modifications
2. **Respecter l'architecture modulaire** existante
3. **Tester les filtres** sur tous les graphiques
4. **Maintenir la compatibilitÃ©** avec le code existant
5. **Documenter les nouvelles fonctionnalitÃ©s** dans ce fichier

Si tu ajoutes un nouveau graphique, pense Ã  :
- CrÃ©er la classe dans `src/charts/`
- L'initialiser dans `main.js`
- Connecter les filtres
- Mettre Ã  jour ce fichier

---

**DerniÃ¨re mise Ã  jour** : 2025-11-17
**Version** : 2.0 (Architecture modulaire stable)
**Statut** : En dÃ©veloppement actif
